<!doctype html>
<html lang="en-us">

<body>
  <input type="range" min="1" max="100" id="slider" />
  <script async type="text/javascript" src="webassembly-jpeg.js"></script>

  <script>
    var Module = {
      onRuntimeInitialized: () => {
        let compress = Module.cwrap('compress', 'number', ['number', 'number', 'number']);
        fetch('jpeg-9c/testimg.jpg')
          .then(response => response.arrayBuffer())
          .then(rawJpeg => {
            let rawJpegAsTypedArray = new Uint8Array(rawJpeg);
            let dataSize = rawJpegAsTypedArray.length;
            let jpegDataInWasm = Module._malloc(dataSize);
            Module.writeArrayToMemory(rawJpegAsTypedArray, jpegDataInWasm);
            let pImage = compress(jpegDataInWasm, dataSize, 1);
            let width = Module.getValue(pImage + 0, 'i32');
            let height = Module.getValue(pImage + 4, 'i32');

            let canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            document.body.appendChild(canvas);
            let context = canvas.getContext('2d');
            let imageData = context.createImageData(width, height);

            function update(quality) {
              let pImage = compress(jpegDataInWasm, dataSize, quality);
              let pBitmapData = Module.getValue(pImage + 12, 'i32');
              let canvasBitmap = new Uint8Array(
                Module.HEAP8.buffer,
                pBitmapData,
                width * height * 4
              );
              imageData.data.set(canvasBitmap);
              context.putImageData(imageData, 0, 0);
              Module._free(pBitmapData);
              Module._free(pImage);
            }

            document.getElementById('slider').oninput = function () {
              update(this.value);
            }

            update(1);
          })
      }
    }
  </script>

</body>

</html>